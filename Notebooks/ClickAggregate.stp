{"metadata":{"guid":"7ac79e08-5c31-4b41-9184-5ddfe009397b","url":"/v2/streaming_pipelines/7ac79e08-5c31-4b41-9184-5ddfe009397b","created_at":"2018-01-15T09:59:40Z","updated_at":"2018-01-18T15:30:05Z","revision":1516289405628},"entity":{"name":"ClickAggregate","description":"","project_guid":"f4bbc994-33be-4d1c-a5a9-48c02017e338","graph":{"doc_type":"pipeline","version":"1.0","json_schema":"http://www.ibm.com/ibm/wdp/flow-v1.0/pipeline-flow-v1-schema.json","id":"","app_data":{"ui_data":{"name":"ClickAggregate"}},"primary_pipeline":"primary-pipeline","pipelines":[{"id":"primary-pipeline","runtime":"streams","nodes":[{"id":"messagehubsample_a0ap2hu9va","type":"binding","op":"ibm.streams.sources.messagehubsample","outputs":[{"id":"target","schema_ref":"schema0","links":[{"node_id_ref":"code_usglok8m6k","port_id_ref":"source"},{"node_id_ref":"code_usglok8m6k","port_id_ref":"source"}]}],"parameters":{"schema_mapping":[{"name":"customer_id","type":"double","path":"/customer_id"},{"name":"time_stamp","type":"timestamp","path":"/time_stamp"},{"name":"click_event_type","type":"string","length":255,"path":"/click_event_type"},{"name":"product_name","type":"string","length":255,"path":"/product_name"},{"name":"product_category","type":"string","length":255,"path":"/product_category"},{"name":"product_price","type":"double","path":"/product_price"},{"name":"total_price_of_basket","type":"double","path":"/total_price_of_basket"},{"name":"total_number_of_items_in_basket","type":"double","path":"/total_number_of_items_in_basket"},{"name":"total_number_of_distinct_items_in_basket","type":"double","path":"/total_number_of_distinct_items_in_basket"},{"name":"session_duration","type":"double","path":"/session_duration"}]},"connection":{"ref":"EXAMPLE_MESSAGE_HUB_CONNECTION","project_ref":"EXAMPLE","properties":{"asset":{"path":"/clickStreamSampleData","type":"topic","name":"Clickstream","id":"clickStreamSampleData"}}},"app_data":{"ui_data":{"label":"Sample Data","x_pos":-510,"y_pos":-20}}},{"id":"code_usglok8m6k","type":"execution_node","op":"ibm.streams.operations.code","outputs":[{"id":"target","schema_ref":"schema1","links":[{"node_id_ref":"objectstorage_v2_jpjzl3yda8","port_id_ref":"source"},{"node_id_ref":"freeform_filter_d8cxqew16q5","port_id_ref":"source"}]}],"parameters":{"code":"#\n# YOU MUST EDIT THE SCHEMA and add all attributes that you are returning as output.\n#\n# Python libraries that are supported and selected (âœ“) at the \"In Installer\" list at\n# https://docs.continuum.io/anaconda/packages/pkg-docs\n\nimport sys\nfrom random import randint\nfrom datetime import datetime, timedelta\n\n# init() function will be called once on pipeline initialization\n# @state a Python dictionary object for keeping state. The state object is passed to the process function\ndef init(state):\n    # do something once on pipeline initialization and save in the state object\n    pass\n\n\n# process() function will be invoked on every event tuple\n# @event a Python dictionary object representing the input event tuple as defined by the input schema\n# @state a Python dictionary object for keeping state over subsequent function calls\n# return must be a Python dictionary object. It will be the output of this operator.\n#        Returning None results in not submitting an output tuple for this invocation.\n# You must declare all output attributes in the Edit Schema window.\ndef process(event, state):\n    # Pass through all of the input fields\n    output = event\n    # Spread time_stamp value randomly over the last 3 days\n    output['time_stamp'] = output['time_stamp'] - timedelta(hours=randint(0,(3*24)))\n    # Isolate Y/M/D/H into new fields to use for partitioning\n    output['YEAR']  = output['time_stamp'].year\n    output['MONTH'] = output['time_stamp'].month\n    output['DAY']   = output['time_stamp'].day\n    output['HOUR']  = output['time_stamp'].hour\n    # Construct the output object, such as by:\n    # output['wordCount'] = len(event['phrase'].split())\n    return output","schema_mapping":[{"name":"YEAR","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"MONTH","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"DAY","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"HOUR","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"time_stamp","type":"timestamp"},{"name":"customer_id","type":"double"},{"name":"click_event_type","type":"string","length":255},{"name":"product_name","type":"string","length":255},{"name":"product_category","type":"string","length":255},{"name":"product_price","type":"double"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"}]},"app_data":{"ui_data":{"label":"Code: Enrich","x_pos":-290,"y_pos":-20}}},{"id":"objectstorage_v2_jpjzl3yda8","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"format":"parquet","partition_value_attributes":["YEAR","MONTH","DAY","HOUR"],"parquet_compression":"SNAPPY","write_policy":"time","rolling_time_seconds":"120"},"connection":{"ref":"b1858d71-ce16-4dfb-911b-cd924233872b","project_ref":"f4bbc994-33be-4d1c-a5a9-48c02017e338","properties":{"asset":{"path":"/click/CLICKALL/prod-%TIME.parq","asset_types":[],"assets":[],"fields":[],"extended_metadata":[],"first":{"href":"https://api.dataplatform.ibm.com/v2/connections/b1858d71-ce16-4dfb-911b-cd924233872b/assets?project_id=f4bbc994-33be-4d1c-a5a9-48c02017e338&offset=0&limit=100&path=%2Fclick%2FCLICKALL%2Fprod-%25TIME.parq"},"total_count":0,"logs":[]}}},"app_data":{"ui_data":{"label":"Cloud OS: All","x_pos":400,"y_pos":-20}}},{"id":"freeform_filter_d8cxqew16q5","type":"execution_node","op":"ibm.streams.operations.freeform-filter","outputs":[{"id":"target","schema_ref":"schema2","links":[{"node_id_ref":"aggregate_0t38buond4gg","port_id_ref":"source"}]}],"parameters":{"expression":"(click_event_type == \"add_to_cart\")"},"app_data":{"ui_data":{"label":"Filter: Products","x_pos":-40,"y_pos":110}}},{"id":"aggregate_0t38buond4gg","type":"execution_node","op":"ibm.streams.operations.aggregate","outputs":[{"id":"target","schema_ref":"schema3","links":[{"node_id_ref":"objectstorage_v2_jgpb4dpzhd","port_id_ref":"source"}]}],"parameters":{"window_number_of_time_units":"30","use_timestamp_in_tuple":false,"partition_by":"product_name","group_by":"","aggregation_output":[{"name":"YEAR","value":{"function":"Any","type":"varchar","arguments":["YEAR"]},"type":""},{"name":"MONTH","value":{"function":"Any","type":"varchar","arguments":["MONTH"]},"type":""},{"name":"DAY","value":{"function":"Any","type":"varchar","arguments":["DAY"]},"type":""},{"name":"HOUR","value":{"function":"Any","type":"varchar","arguments":["HOUR"]},"type":""},{"name":"time_stamp","value":{"function":"Any","type":"timestamp","arguments":["time_stamp"]},"type":""},{"name":"product_category","value":{"function":"Any","type":"varchar","arguments":["product_category"]},"type":""},{"name":"product_name","value":{"function":"Any","type":"varchar","arguments":["product_name"]},"type":""},{"name":"count","value":{"function":"Count","type":"varchar","arguments":[]},"type":""},{"name":"sales","value":{"function":"Sum","type":"double","arguments":["product_price"]},"type":""}],"schema_mapping":[{"name":"YEAR","type":"string"},{"name":"MONTH","type":"string"},{"name":"DAY","type":"string"},{"name":"HOUR","type":"string"},{"name":"time_stamp","type":"timestamp"},{"name":"product_category","type":"string"},{"name":"product_name","type":"string"},{"name":"count","type":"integer"},{"name":"sales","type":"double"}]},"app_data":{"ui_data":{"label":"Aggregation","x_pos":180,"y_pos":110}}},{"id":"objectstorage_v2_jgpb4dpzhd","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"format":"parquet","partition_value_attributes":["YEAR","MONTH","DAY","HOUR"],"parquet_compression":"SNAPPY","write_policy":"time","rolling_time_seconds":"120"},"connection":{"ref":"b1858d71-ce16-4dfb-911b-cd924233872b","project_ref":"f4bbc994-33be-4d1c-a5a9-48c02017e338","properties":{"asset":{"path":"/click/CLICKAGGPROD/prod-%TIME.parq","asset_types":[],"assets":[],"fields":[],"extended_metadata":[],"first":{"href":"https://api.dataplatform.ibm.com/v2/connections/b1858d71-ce16-4dfb-911b-cd924233872b/assets?project_id=f4bbc994-33be-4d1c-a5a9-48c02017e338&offset=0&limit=100&path=%2Fclick%2FCLICKAGGPROD%2Fprod-%25TIME.parq"},"total_count":0,"logs":[]}}},"app_data":{"ui_data":{"label":"Cloud OS: Product","x_pos":400,"y_pos":110}}}]}],"schemas":[{"id":"schema0","fields":[{"name":"customer_id","type":"double"},{"name":"time_stamp","type":"timestamp"},{"name":"click_event_type","type":"string"},{"name":"product_name","type":"string"},{"name":"product_category","type":"string"},{"name":"product_price","type":"double"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"}]},{"id":"schema1","fields":[{"name":"YEAR","type":"string"},{"name":"MONTH","type":"string"},{"name":"DAY","type":"string"},{"name":"HOUR","type":"string"},{"name":"time_stamp","type":"timestamp"},{"name":"customer_id","type":"double"},{"name":"click_event_type","type":"string"},{"name":"product_name","type":"string"},{"name":"product_category","type":"string"},{"name":"product_price","type":"double"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"}]},{"id":"schema2","fields":[{"name":"YEAR","type":"string"},{"name":"MONTH","type":"string"},{"name":"DAY","type":"string"},{"name":"HOUR","type":"string"},{"name":"time_stamp","type":"timestamp"},{"name":"customer_id","type":"double"},{"name":"click_event_type","type":"string"},{"name":"product_name","type":"string"},{"name":"product_category","type":"string"},{"name":"product_price","type":"double"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"}]},{"id":"schema3","fields":[{"name":"YEAR","type":"string"},{"name":"MONTH","type":"string"},{"name":"DAY","type":"string"},{"name":"HOUR","type":"string"},{"name":"time_stamp","type":"timestamp"},{"name":"product_category","type":"string"},{"name":"product_name","type":"string"},{"name":"count","type":"integer"},{"name":"sales","type":"double"}]}]},"engines":{"streams":{"instance_id":"779ee6ed-4f31-40d2-b59a-7a277c32a2d6"}}}}